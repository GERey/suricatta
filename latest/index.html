<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<meta name="author" content="Andrey Antukh, &lt;niwi@niwi.nz&gt;">
<title>suricatta documentation</title>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments, .listingblock .pygments code { background: #f0f0f0; }
.listingblock .pygments .tok-c { color: #60a0b0; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #007020; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #007020 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #007020; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #007020 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #902000 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #40a070 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #4070a0 } /* Literal.String */
.listingblock .pygments .tok-na { color: #4070a0 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #007020 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0e84b5; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #60add5 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #555555; font-weight: bold } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #d55537; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #007020 } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #06287e } /* Name.Function */
.listingblock .pygments .tok-nl { color: #002070; font-weight: bold } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #062873; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #bb60d5 } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #007020; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #40a070 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #40a070 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #40a070 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #40a070 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #40a070 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #4070a0 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #4070a0 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #4070a0 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #4070a0 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #c65d09 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #235388 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #4070a0 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #517918 } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #007020 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #bb60d5 } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #bb60d5 } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #bb60d5 } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #40a070 } /* Literal.Number.Integer.Long */
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Liberation+Mono:400|Roboto+Slab:400,700"/>
<link rel="stylesheet" href="http://assets.niwi.nz/asciidoctor-styles/simple-red-titles/stylesheet.css"/>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>suricatta documentation</h1>
<div class="details">
<span id="author" class="author">Andrey Antukh, &lt;niwi@niwi.nz&gt;</span><br>
<span id="revdate">1.3.1</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_project_maturity">Project Maturity</a></li>
<li><a href="#_install">Install</a></li>
</ul>
</li>
<li><a href="#_sql_execution">SQL Execution</a>
<ul class="sectlevel2">
<li><a href="#_connecting_to_database">Connecting to database</a></li>
<li><a href="#_executing_queries">Executing queries</a></li>
<li><a href="#_fetching_results">Fetching results</a></li>
<li><a href="#_parametrized_queries">Parametrized queries</a></li>
<li><a href="#_reusing_query_statement">Reusing query statement</a></li>
<li><a href="#_transactions">Transactions</a></li>
<li><a href="#_lazy_result_fetching">Lazy result fetching</a></li>
<li><a href="#_custom_types">Custom types</a></li>
</ul>
</li>
<li><a href="#_sql_building_and_formatting">SQL Building and Formatting</a>
<ul class="sectlevel2">
<li><a href="#_the_select_statement">The SELECT statement</a></li>
<li><a href="#_the_insert_statement">The INSERT statement</a></li>
<li><a href="#_the_update_statement">The UPDATE statement</a></li>
<li><a href="#_the_delete_statement">The DELETE statement</a></li>
<li><a href="#_the_ddl_statements">The DDL statements</a></li>
<li><a href="#_table_expressions">Table Expressions</a></li>
</ul>
</li>
<li><a href="#_faq">FAQ</a>
<ul class="sectlevel2">
<li><a href="#_why_i_should_use_suricatta_instead_of_clojure_jdbc_or_java_jdbc">Why I should use suricatta instead of clojure.jdbc or java.jdbc?</a></li>
<li><a href="#_where_is_the_async_support">Where is the async support?</a></li>
<li><a href="#_why_another_dsl_is_it_just_yet_another_dsl">Why another dsl? Is it just yet another dsl?</a></li>
<li><a href="#_what_are_some_suricatta_use_cases">What are some suricatta use cases?</a></li>
<li><a href="#_is_it_a_korma_clone">Is it a korma-clone?</a></li>
<li><a href="#_is_a_jooq_comercial_license_requried">Is a JOOQ comercial license requried?</a></li>
<li><a href="#_can_i_store_safely_queries_builded_by_dsl_in_a_var_they_are_immutable">Can I store safely queries builded by DSL in a var, they are immutable?</a></li>
</ul>
</li>
<li><a href="#_developers_guide">Developers Guide</a>
<ul class="sectlevel2">
<li><a href="#_philosophy">Philosophy</a></li>
<li><a href="#_contributing">Contributing</a></li>
<li><a href="#_source_code">Source Code</a></li>
<li><a href="#_run_tests">Run tests</a></li>
<li><a href="#_license">License</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction"><a class="link" href="#_introduction">Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>suricatta</em> is a high level sql toolkit for clojure (backed by fantastic
<a href="http://www.jooq.org/">jooq library</a>)</p>
</div>
<div class="paragraph">
<p>It consists in four modules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>suricatta.core</strong>: api for executing queries.</p>
</li>
<li>
<p><strong>suricatta.dsl</strong>: lightweight dsl for idiomatic and composable sql building.</p>
</li>
<li>
<p><strong>suricatta.format</strong>: sql rendering functions.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_project_maturity"><a class="link" href="#_project_maturity">Project Maturity</a></h3>
<div class="paragraph">
<p>Since <em>suricatta</em> is a young project there may be some API breakage.</p>
</div>
</div>
<div class="sect2">
<h3 id="_install"><a class="link" href="#_install">Install</a></h3>
<div class="paragraph">
<p>The simplest way to use <em>suricatta</em> in a clojure project, is by including it in the
dependency vector on your <strong><em>project.clj</em></strong> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[</span><span class="tok-nv">funcool/suricatta</span> <span class="tok-s">&quot;1.3.1&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Suricatta</em> is only runs with <strong>JDK &gt;= 8</strong> and <strong>Clojure &gt;= 1.5</strong></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sql_execution"><a class="link" href="#_sql_execution">SQL Execution</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section explains the usage of the sql execution part of the library.</p>
</div>
<div class="sect2">
<h3 id="_connecting_to_database"><a class="link" href="#_connecting_to_database">Connecting to database</a></h3>
<div class="paragraph">
<p><em>suricatta</em>, unlike other database libraries, uses a concept of <strong>context</strong> instead
of <strong>connection</strong>. A <strong>context</strong> has the resposibility of jdbc connection resource
management, transaction isolation flags and sql rendering dialect.</p>
</div>
<div class="paragraph">
<p>You can create a <strong>context</strong> from:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a hash-map dbspec format (plain connection params).</p>
</li>
<li>
<p>a datasource instance (connection pool).</p>
</li>
<li>
<p>a <a href="http://funcool.github.io/clojure.jdbc/latest/">clojure.jdbc</a> connection
instance.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">This is a default aspect of one dbspec.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">dbspec</span> <span class="tok-p">{</span><span class="tok-ss">:subprotocol</span> <span class="tok-s">&quot;postgresql&quot;</span>
             <span class="tok-ss">:subname</span> <span class="tok-s">&quot;//localhost:5432/dbname&quot;</span>
             <span class="tok-ss">:user</span> <span class="tok-s">&quot;username&quot;</span>         <span class="tok-c1">;; Optional</span>
             <span class="tok-ss">:password</span> <span class="tok-s">&quot;password&quot;</span><span class="tok-p">}</span>    <span class="tok-c1">;; Optional</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_create_context_from_plain_dbspec"><a class="link" href="#_create_context_from_plain_dbspec">Create Context from plain dbspec.</a></h4>
<div class="listingblock">
<div class="title">Example creating context from dbspec.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">suricatta.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">sc</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nb">with-open </span><span class="tok-p">[</span><span class="tok-nv">ctx</span> <span class="tok-p">(</span><span class="tok-nf">sc/context</span> <span class="tok-p">{</span><span class="tok-ss">:subprotocol</span> <span class="tok-s">&quot;h2&quot;</span>
                             <span class="tok-ss">:subname</span> <span class="tok-s">&quot;mem:&quot;</span><span class="tok-p">})]</span>
  <span class="tok-p">(</span><span class="tok-nf">do-something-with</span> <span class="tok-nv">ctx</span><span class="tok-p">))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_context_from_em_clojure_jdbc_em_connection"><a class="link" href="#_create_context_from_em_clojure_jdbc_em_connection">Create Context from <em>clojure.jdbc</em> connection.</a></h4>
<div class="listingblock">
<div class="title">Example creating context from <em>clojure.jdbc</em> connection instance.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">jdbc.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">jdbc</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">suricatta.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">sc</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">dbspec</span> <span class="tok-p">{</span><span class="tok-ss">:subprotocol</span> <span class="tok-s">&quot;h2&quot;</span>
             <span class="tok-ss">:subname</span> <span class="tok-s">&quot;mem:&quot;</span><span class="tok-p">})</span>

<span class="tok-p">(</span><span class="tok-nb">with-open </span><span class="tok-p">[</span><span class="tok-nv">conn</span> <span class="tok-p">(</span><span class="tok-nf">jdbc/connection</span> <span class="tok-nv">dbspec</span><span class="tok-p">)</span>
            <span class="tok-nv">ctx</span> <span class="tok-p">(</span><span class="tok-nf">sc/context</span> <span class="tok-nv">conn</span><span class="tok-p">)]</span>
  <span class="tok-p">(</span><span class="tok-nf">do-something</span> <span class="tok-nv">ctx</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
when closing the <em>suricatta</em> context, the wrapped connection will also be closed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_create_context_from_datasource"><a class="link" href="#_create_context_from_datasource">Create Context from DataSource.</a></h4>
<div class="paragraph">
<p>DataSource is the preferd way to connect to the database in production enviroments
and is usually used to implement connection pools.</p>
</div>
<div class="paragraph">
<p>In our case we will use <strong>hikaricp</strong> as a datasource with a connection pool. Lets
start by adding hikari&#8217;s dependency entry to your <em>project.clj</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[</span><span class="tok-nv">hikari-cp</span> <span class="tok-s">&quot;0.13.0&quot;</span> <span class="tok-ss">:exclusions</span> <span class="tok-p">[</span><span class="tok-nv">com.zaxxer/HikariCP</span><span class="tok-p">]]</span>
<span class="tok-p">[</span><span class="tok-nv">com.zaxxer/HikariCP-java6</span> <span class="tok-s">&quot;2.2.5&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now create the datasource instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">hikari-cp.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">hikari</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-o">^</span><span class="tok-nv">javax.sql.Datasource</span>
  <span class="tok-nv">datasource</span> <span class="tok-p">(</span><span class="tok-nf">hikari/make-datasource</span>
              <span class="tok-p">{</span><span class="tok-ss">:connection-timeout</span> <span class="tok-mi">30000</span>
               <span class="tok-ss">:idle-timeout</span> <span class="tok-mi">600000</span>
               <span class="tok-ss">:max-lifetime</span> <span class="tok-mi">1800000</span>
               <span class="tok-ss">:minimum-idle</span> <span class="tok-mi">10</span>
               <span class="tok-ss">:maximum-pool-size</span>  <span class="tok-mi">10</span>
               <span class="tok-ss">:adapter</span> <span class="tok-s">&quot;postgresql&quot;</span>
               <span class="tok-ss">:username</span> <span class="tok-s">&quot;username&quot;</span>
               <span class="tok-ss">:password</span> <span class="tok-s">&quot;password&quot;</span>
               <span class="tok-ss">:database-name</span> <span class="tok-s">&quot;database&quot;</span>
               <span class="tok-ss">:server-name</span> <span class="tok-s">&quot;localhost&quot;</span>
               <span class="tok-ss">:port-number</span> <span class="tok-mi">5432</span><span class="tok-p">}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, having a datasource instace, you can use it like plain dbspec for creating
a context instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">with-open </span><span class="tok-p">[</span><span class="tok-nv">ctx</span> <span class="tok-p">(</span><span class="tok-nf">sc/context</span> <span class="tok-nv">datasource</span><span class="tok-p">)]</span>
  <span class="tok-p">(</span><span class="tok-nf">do-something-with</span> <span class="tok-nv">ctx</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can found more information and documentation about hikari-cp
here: <a href="https://github.com/tomekw/hikari-cp" class="bare">https://github.com/tomekw/hikari-cp</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_executing_queries"><a class="link" href="#_executing_queries">Executing queries</a></h3>
<div class="paragraph">
<p><em>suricatta</em> has a clear separation between queries that can return a result, and
queries that can&#8217;t.</p>
</div>
<div class="listingblock">
<div class="title">Example using <code>suricatta.core/execute</code> function.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">suricatta.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">sc</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">sc/execute</span> <span class="tok-nv">ctx</span> <span class="tok-s">&quot;CREATE TABLE foo&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The return value of <code>suricatta.core/execute</code> function depends on the query, but
in almost all cases it returns a number of affected rows.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fetching_results"><a class="link" href="#_fetching_results">Fetching results</a></h3>
<div class="paragraph">
<p>Let see an example of how to execute a query and fetch results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">suricatta.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">sc</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">ctx</span> <span class="tok-s">&quot;select x from generate_series(1,3) as x&quot;</span><span class="tok-p">)</span>
<span class="tok-c1">;; =&gt; [{:x 1} {:x 2} {:x 3}]</span>

<span class="tok-p">(</span><span class="tok-nf">sc/fetch-one</span> <span class="tok-nv">ctx</span> <span class="tok-s">&quot;select x from generate_series(1,1) as x&quot;</span><span class="tok-p">)</span>
<span class="tok-c1">;; =&gt; {:x 1}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><em>suricatta</em> gives you the power of raw sql queries without
any restrictions (unlike jdbc). As a great example, <em>suricatta</em> does
not have special syntax for queries with <code>RETURNING</code> clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">ctx</span> <span class="tok-s">&quot;INSERT INTO foo (name) values (&#39;bar&#39;) returning id&quot;</span><span class="tok-p">)</span>
<span class="tok-c1">;; =&gt; [{:id 27}]</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_parametrized_queries"><a class="link" href="#_parametrized_queries">Parametrized queries</a></h3>
<div class="paragraph">
<p>Like <em>clojure.jdbc</em> and <em>clojure.java.jdbc</em>, <em>suricatta</em> has support for
parametrized queries in <strong>sqlvec</strong> format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">ctx</span> <span class="tok-p">[</span><span class="tok-s">&quot;select id from books where age &gt; ? limit 1&quot;</span> <span class="tok-mi">100</span><span class="tok-p">])</span>
<span class="tok-c1">;; =&gt; [{:id 4232}]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reusing_query_statement"><a class="link" href="#_reusing_query_statement">Reusing query statement</a></h3>
<div class="paragraph">
<p>The above technique can be quite useful when you want to reuse expensive database
resources.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">with-open </span><span class="tok-p">[</span><span class="tok-nv">q</span> <span class="tok-p">(</span><span class="tok-nf">sc/query</span> <span class="tok-nv">ctx</span> <span class="tok-p">[</span><span class="tok-s">&quot;select ?&quot;</span> <span class="tok-mi">1</span><span class="tok-p">])]</span>
  <span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">q</span><span class="tok-p">)</span>  <span class="tok-c1">;; Creates a statement</span>
  <span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">q</span><span class="tok-p">))</span> <span class="tok-c1">;; Reuses the previous created statement</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transactions"><a class="link" href="#_transactions">Transactions</a></h3>
<div class="paragraph">
<p>The <em>suricatta</em> library does not have support for low level transactions api,
instead of it, offers a lightweight abstraction over complex transaction api.</p>
</div>
<div class="listingblock">
<div class="title">Execute a query in a transaction block.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">sc/atomic-apply</span> <span class="tok-nv">ctx</span> <span class="tok-p">(</span><span class="tok-k">fn </span><span class="tok-p">[</span><span class="tok-nv">ctx</span><span class="tok-p">]</span>
                       <span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">ctx</span> <span class="tok-s">&quot;select id, name from book for update&quot;</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally to <code>atomic-apply</code> high order functiom, <em>suricatta</em> has a convenient
macro offering lightweight sugar sytax for atomic blocks:</p>
</div>
<div class="listingblock">
<div class="title">Execute a query in a transaction block using sugar syntax macro.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">sc/atomic</span> <span class="tok-nv">ctx</span>
  <span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">ctx</span> <span class="tok-s">&quot;select id, name from book for update&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can nest atomic usage as deep as you want, subtransactions are fully supported.</p>
</div>
<div class="paragraph">
<p>If an exception is raised inside atomic context the transaction will be aborted.
Also, in some circumstances, you probably want an explicit rollback, for which
the <em>suricatta</em> library exposes a <code>suricatta.core/set-rollback!</code> function.</p>
</div>
<div class="listingblock">
<div class="title">Explicit rollback example</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">sc/atomic</span> <span class="tok-nv">ctx</span>
  <span class="tok-p">(</span><span class="tok-nf">sc/execute</span> <span class="tok-nv">ctx</span> <span class="tok-s">&quot;update table1 set f1 = 1&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">sc/set-rollback!</span> <span class="tok-nv">ctx</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>set-rollback!</code> function only marks the current transaction for rollback. It
does not abort the execution, and it is aware of subtransactions. If it is used
in a subtransaction, only the subtransaction will be marked for rollback, not
the entire transaction.</p>
</div>
</div>
<div class="sect2">
<h3 id="_lazy_result_fetching"><a class="link" href="#_lazy_result_fetching">Lazy result fetching</a></h3>
<div class="paragraph">
<p>The <em>suricatta</em> library also comes with lazy fetching support. When lazy fetching
support is enabled, instead of fetching all results in memory, suricatta will
fetch results in small groups, allowing lower memory usage.</p>
</div>
<div class="paragraph">
<p>Lazy fetching has a few quirks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In some databases, like <em>PostgreSQL</em>, it requires the entire fetch to occur in
one transaction because it uses  server side cursors.</p>
</li>
<li>
<p>Lazy fetching requires explicit resource management, because a connection and
an internal resultset must be mantained open until fetching is finished.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using lazy fetch is realy easy, because suricatta exposes it as a simple lazy
sequence. Let&#8217;s see one example:</p>
</div>
<div class="listingblock">
<div class="title">Example executing large query and fetching elemens in groups of 10.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">sql</span> <span class="tok-s">&quot;SELECT x FROM generate_series(1, 10000)&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nf">sc/atomic</span> <span class="tok-nv">ctx</span>
  <span class="tok-p">(</span><span class="tok-nb">with-open </span><span class="tok-p">[</span><span class="tok-nv">cursor</span> <span class="tok-p">(</span><span class="tok-nf">sc/fetch-lazy</span> <span class="tok-nv">ctx</span> <span class="tok-nv">sql</span> <span class="tok-p">{</span><span class="tok-ss">:fetch-size</span> <span class="tok-mi">10</span><span class="tok-p">})]</span>
    <span class="tok-p">(</span><span class="tok-nb">doseq </span><span class="tok-p">[</span><span class="tok-nv">item</span> <span class="tok-p">(</span><span class="tok-nf">sc/cursor-&gt;lazyseq</span> <span class="tok-nv">cursor</span><span class="tok-p">)]</span>
      <span class="tok-p">(</span><span class="tok-nb">println </span><span class="tok-nv">item</span><span class="tok-p">))))</span>

<span class="tok-c1">;; This should print something similar to:</span>
<span class="tok-c1">;; {:x 1}</span>
<span class="tok-c1">;; {:x 2}</span>
<span class="tok-c1">;; ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The third parameter of <code>sc/fetch-lazy</code> function is the optional default fetch
size (currently 100.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_custom_types"><a class="link" href="#_custom_types">Custom types</a></h3>
<div class="paragraph">
<p>Since 0.2.0 version, suricatta comes with support for extension with custom
(or vendor specific) types support. It consist in two protocols, one for converting
user defined types to jooq/jdbc compatible types, and other for backwards conversion.</p>
</div>
<div class="listingblock">
<div class="title">Example adapting clojure persistent map interface to postgresql json file.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">suricatta.proto</span> <span class="tok-ss">:as</span> <span class="tok-nv">proto</span><span class="tok-p">]</span>
         <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cheshire.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">json</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-nb">import </span><span class="tok-ss">&#39;org.postgresql.util.PGobject</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nf">extend-protocol</span> <span class="tok-nv">proto/IParamType</span>
  <span class="tok-nv">clojure.lang.IPersistentMap</span>
  <span class="tok-p">(</span><span class="tok-nf">-render</span> <span class="tok-p">[</span><span class="tok-nv">self</span> <span class="tok-nv">ctx</span><span class="tok-p">]</span>
    <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">proto/-inline?</span> <span class="tok-nv">ctx</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nb">str </span><span class="tok-s">&quot;&#39;&quot;</span> <span class="tok-p">(</span><span class="tok-nf">json/encode</span> <span class="tok-nv">self</span><span class="tok-p">)</span> <span class="tok-s">&quot;&#39;::json&quot;</span><span class="tok-p">)</span>
      <span class="tok-s">&quot;?::json&quot;</span><span class="tok-p">))</span>

  <span class="tok-p">(</span><span class="tok-nf">-bind</span> <span class="tok-p">[</span><span class="tok-nv">self</span> <span class="tok-nv">ctx</span><span class="tok-p">]</span>
    <span class="tok-p">(</span><span class="tok-nb">when-not </span><span class="tok-p">(</span><span class="tok-nf">proto/-inline?</span> <span class="tok-nv">ctx</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">stmt</span> <span class="tok-p">(</span><span class="tok-nf">proto/-statement</span> <span class="tok-nv">ctx</span><span class="tok-p">)</span>
            <span class="tok-nv">idx</span>  <span class="tok-p">(</span><span class="tok-nf">proto/-next-bind-index</span> <span class="tok-nv">ctx</span><span class="tok-p">)</span>
            <span class="tok-nv">obj</span> <span class="tok-p">(</span><span class="tok-nb">doto </span><span class="tok-p">(</span><span class="tok-nf">PGobject.</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nf">.setType</span> <span class="tok-s">&quot;json&quot;</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nf">.setValue</span> <span class="tok-p">(</span><span class="tok-nf">json/encode</span> <span class="tok-p">(</span><span class="tok-nf">.-data</span> <span class="tok-nv">self</span><span class="tok-p">))))]</span>
        <span class="tok-p">(</span><span class="tok-nf">.setObject</span> <span class="tok-nv">stmt</span> <span class="tok-nv">idx</span> <span class="tok-nv">obj</span><span class="tok-p">)))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-render</code> function is responsible of generate the appropiate sql for this field.
The value should be inlined or rendered as bind ready parameter depending on the
<code>inline</code> value that can be retrieved from the <code>RenderContext</code>.</p>
</div>
<div class="paragraph">
<p>The <code>-bind</code> function reponsibility is just bind the appropiate values to the
prepared statement only if the context indicates that is not inlined.</p>
</div>
<div class="paragraph">
<p>Now let see the backward conversion example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">extend-protocol</span> <span class="tok-nv">proto/ISQLType</span>
  <span class="tok-nv">PGobject</span>
  <span class="tok-p">(</span><span class="tok-nf">-convert</span> <span class="tok-p">[</span><span class="tok-nv">self</span><span class="tok-p">]</span>
    <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">type</span> <span class="tok-p">(</span><span class="tok-nf">.getType</span> <span class="tok-nv">self</span><span class="tok-p">)]</span>
      <span class="tok-p">(</span><span class="tok-nf">condp</span> <span class="tok-nb">= </span><span class="tok-nv">type</span>
        <span class="tok-s">&quot;json&quot;</span> <span class="tok-p">(</span><span class="tok-nf">json/decode</span> <span class="tok-p">(</span><span class="tok-nf">.getValue</span> <span class="tok-nv">self</span><span class="tok-p">)</span> <span class="tok-nv">true</span><span class="tok-p">)))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Having defined the two way conversions, you can pass the clojure hash-map as a
value to the query and it is automatically converted.</p>
</div>
<div class="listingblock">
<div class="title">Insert and query example using postgresql json fields.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-c1">;; Create table</span>
<span class="tok-p">(</span><span class="tok-nf">sc/execute</span> <span class="tok-nv">ctx</span> <span class="tok-s">&quot;create table t1 (k json)&quot;</span><span class="tok-p">)</span>

<span class="tok-c1">;; Insert a json value</span>
<span class="tok-p">(</span><span class="tok-nf">sc/execute</span> <span class="tok-nv">ctx</span> <span class="tok-p">[</span><span class="tok-s">&quot;insert into t1 (k) values (?)&quot;</span> <span class="tok-p">{</span><span class="tok-ss">:foo</span> <span class="tok-mi">1</span><span class="tok-p">}])</span>

<span class="tok-c1">;; Query a table with json value</span>
<span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">ctx</span> <span class="tok-p">[</span><span class="tok-s">&quot;select * from t1&quot;</span><span class="tok-p">])</span>
<span class="tok-c1">;; =&gt; [{:k {:foo 1}}]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sql_building_and_formatting"><a class="link" href="#_sql_building_and_formatting">SQL Building and Formatting</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section intends to explain the usage of sql building library, the lightweight
layer on top of <code>jooq</code> dsl.</p>
</div>
<div class="paragraph">
<p>You can found all related functions of sql dsl on <code>suricatta.dsl</code> namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">suricatta.dsl</span> <span class="tok-ss">:as</span> <span class="tok-nv">dsl</span><span class="tok-p">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And functions related to formating sql into string or sqlvec format in
<code>suricatta.format</code> namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">suricatta.format</span> <span class="tok-ss">:as</span> <span class="tok-nv">fmt</span><span class="tok-p">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Object instances retured by dsl api are fully compatible with the sql executing
api. Let see an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">my-query</span>
  <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:id</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:books</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-p">[</span><span class="tok-s">&quot;age &gt; ?&quot;</span>, <span class="tok-mi">100</span><span class="tok-p">])</span>
      <span class="tok-p">(</span><span class="tok-nf">dsl/limit</span> <span class="tok-mi">1</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nb">with-open </span><span class="tok-p">[</span><span class="tok-nv">ctx</span> <span class="tok-p">(</span><span class="tok-nf">sc/context</span> <span class="tok-nv">dbspec</span><span class="tok-p">)]</span>
  <span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">ctx</span> <span class="tok-nv">my-query</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; [{:id 4232}]</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_the_select_statement"><a class="link" href="#_the_select_statement">The SELECT statement</a></h3>
<div class="sect3">
<h4 id="_select_clause"><a class="link" href="#_select_clause">Select clause</a></h4>
<div class="paragraph">
<p>Simple select clause without from part:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:id</span> <span class="tok-ss">:name</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Would generate SQL like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">select</span> <span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-n">name</span> <span class="tok-k">from</span> <span class="tok-n">dual</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The rendering result depends on the dialect used. You can specify a different
dialect by passing the <code>:dialect</code> option to the <code>sql</code> function of
<code>suricatta.format</code> namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:id</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span> <span class="tok-p">{</span><span class="tok-ss">:dialect</span> <span class="tok-ss">:postgresql</span><span class="tok-p">}))</span>
<span class="tok-c1">;; =&gt; &quot;select id, name&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_select_distinct"><a class="link" href="#_select_distinct">Select DISTINCT</a></h4>
<div class="paragraph">
<p>You can add the distinct keyword by using a special select function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select-distinct</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select distinct name&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_select"><a class="link" href="#_select">Select *</a></h4>
<div class="paragraph">
<p>You can ommit fields on <code>select</code> function to use the "SELECT *" sql form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select * from book&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_select_with_function"><a class="link" href="#_select_with_function">Select with function</a></h4>
<div class="paragraph">
<p>In select clauses you can put any kind of expresions such as sql functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;length(book.title)&quot;</span> <span class="tok-s">&quot;title_length&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select length(book.title) \&quot;title_length\&quot; from book&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_from_clause"><a class="link" href="#_the_from_clause">The FROM clause</a></h4>
<div class="paragraph">
<p>A simple sql "select &#8230;&#8203; from" clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:book.id</span> <span class="tok-ss">:book.name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select book.id, book.name from book&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, the sql from clause supports any number of tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select-one</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span> <span class="tok-ss">:article</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select 1 from book, article&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, you can specify an alias for each table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select-one</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;book&quot;</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)</span>
              <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;article&quot;</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select 1 from book \&quot;a\&quot;, article \&quot;b\&quot;&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_join_clause"><a class="link" href="#_the_join_clause">The JOIN clause</a></h4>
<div class="paragraph">
<p><em>suricata</em> comes with a complete dsl for making join clauses. Let see one
simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/join</span> <span class="tok-ss">:author</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/on</span> <span class="tok-s">&quot;book.author_id = book.id&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book join author on (book.author_id = book.id)&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use table aliases with join clauses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;book&quot;</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/join</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;author&quot;</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/on</span> <span class="tok-s">&quot;b.author_id = a.id&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book \&quot;b\&quot; join author \&quot;a\&quot; on (b.author_id = a.id)&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, join clause can be applied to table expressions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/table</span> <span class="tok-s">&quot;book&quot;</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nf">dsl/join</span> <span class="tok-s">&quot;author&quot;</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nf">dsl/on</span> <span class="tok-s">&quot;book.author_id = book.id&quot;</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book join author on (book.author_id = book.id)&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_where_clause"><a class="link" href="#_the_where_clause">The WHERE clause</a></h4>
<div class="paragraph">
<p>The WHERE clause can be used to JOIN or filter predicates in order to restrict
the data returned by the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-s">&quot;book.age &gt; 100&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book where (book.age &gt; 100)&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Building a where clause with multiple conditions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-s">&quot;book.age &gt; 100&quot;</span>
               <span class="tok-s">&quot;book.in_store = true&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book where ((book.age &gt; 100) and (book.in_store = true))&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Bind parameters instead of inlining them on conditions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-p">[</span><span class="tok-s">&quot;book.age &gt; ?&quot;</span> <span class="tok-mi">100</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-s">&quot;book.in_store = ?&quot;</span>, <span class="tok-nv">true</span><span class="tok-p">])</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sqlvec</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; [&quot;select name from book where ((book.age &gt; ?) and (book.in_store = ?))&quot; 100 true]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using explicit logical operators:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-p">(</span><span class="tok-nf">dsl/or</span> <span class="tok-s">&quot;book.age &gt; 20&quot;</span>
                       <span class="tok-p">(</span><span class="tok-nf">dsl/not</span> <span class="tok-s">&quot;book.in_store&quot;</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book where ((book.age &gt; 20) or (not book.in_store))&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Different kind of joins are suported with that functions: <code>dsl/full-outer-join</code>,
<code>dsl/left-outer-join</code>, <code>dsl/right-outer-join</code> and <code>dsl/cross-join</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_group_by_clause"><a class="link" href="#_the_group_by_clause">The GROUP BY clause</a></h4>
<div class="paragraph">
<p>GROUP BY can be used to create unique groups of data, to form aggregations, to
remove duplicates and for other reasons. Let see an example of how it can be
done using the <em>suricatta</em> dsl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-p">(</span><span class="tok-nf">dsl/field</span> <span class="tok-s">&quot;name&quot;</span><span class="tok-p">)</span>
                <span class="tok-p">(</span><span class="tok-nf">dsl/field</span> <span class="tok-s">&quot;count(*)&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/group-by</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name, count(*) from book group by name&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_having_clause"><a class="link" href="#_the_having_clause">The HAVING clause</a></h4>
<div class="paragraph">
<p>The HAVING clause is used to further restrict aggregated data. Let see an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-p">(</span><span class="tok-nf">dsl/field</span> <span class="tok-s">&quot;name&quot;</span><span class="tok-p">)</span>
                <span class="tok-p">(</span><span class="tok-nf">dsl/field</span> <span class="tok-s">&quot;count(*)&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/group-by</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/having</span> <span class="tok-p">[</span><span class="tok-s">&quot;count(*) &gt; ?&quot;</span>, <span class="tok-mi">2</span><span class="tok-p">])</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name, count(*) from book group by name having (count(*) &gt; ?)&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_order_by_clause"><a class="link" href="#_the_order_by_clause">The ORDER BY clause</a></h4>
<div class="paragraph">
<p>Here&#8217;s an example of how specify the ordering to the query:</p>
</div>
<div class="listingblock">
<div class="title">Ordering by field with implicit sort direction</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/order-by</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book order by name asc&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In previous example we specified the order field without order direction.
<em>surricata</em> automatically uses <code>ASC</code> for sort fields that comes without explicit
ordering direction.</p>
</div>
<div class="listingblock">
<div class="title">Specify sort direction explicitly</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/order-by</span> <span class="tok-p">[</span><span class="tok-ss">:name</span> <span class="tok-ss">:desc</span><span class="tok-p">])</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book order by name desc&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Handling nulls</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/order-by</span> <span class="tok-p">[</span><span class="tok-ss">:name</span> <span class="tok-ss">:desc</span> <span class="tok-ss">:nulls-last</span><span class="tok-p">])</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book order by name desc nulls last&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ordering by index</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:id</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/order-by</span> <span class="tok-p">[</span><span class="tok-s">&quot;1&quot;</span> <span class="tok-ss">:asc</span><span class="tok-p">]</span>
                  <span class="tok-p">[</span><span class="tok-s">&quot;2&quot;</span> <span class="tok-ss">:desc</span><span class="tok-p">])</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book order by 1 asc, 2 desc&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_limit_and_offset_clauses"><a class="link" href="#_the_limit_and_offset_clauses">The LIMIT and OFFSET clauses</a></h4>
<div class="paragraph">
<p>Let see some examples of how to apply <code>limit</code> and <code>offset</code> to your queries
with <em>suricatta</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:id</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/limit</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/offset</span> <span class="tok-mi">100</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select name from book limit ? offset ?&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_for_update_clause"><a class="link" href="#_the_for_update_clause">The FOR UPDATE clause</a></h4>
<div class="paragraph">
<p>For inter-process synchronisation and other reasons, you may choose to use the
<code>SELECT .. FOR UPDATE</code> clause to indicate to the database, that a set of cells
or records should be locked by a given transaction for subsequent updates. Let
see an example of how use it with <em>suricatta</em> dsl:</p>
</div>
<div class="listingblock">
<div class="title">Without specific fields</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/for-update</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select * from book for update&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">With specific fields</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/for-update</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select * from book for update of \&quot;name\&quot;&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_union_and_union_all_clause"><a class="link" href="#_the_union_and_union_all_clause">The UNION and UNION ALL clause</a></h4>
<div class="paragraph">
<p>These operators combine two results into one. UNION removes all duplicate
records resulting from this combination and UNION ALL preserves all results as
they are.</p>
</div>
<div class="listingblock">
<div class="title">Using UNION clause</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/union</span>
    <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:books</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:articles</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;(select name from books) union (select name from articles)&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Using UNION ALL clause</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/union-all</span>
    <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:books</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:articles</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;(select name from books) union all (select name from articles)&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_insert_statement"><a class="link" href="#_the_insert_statement">The INSERT statement</a></h3>
<div class="paragraph">
<p>The INSERT statement is used to insert new records into a database table.</p>
</div>
<div class="listingblock">
<div class="title">Example of insert two rows in one table.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/insert-into</span> <span class="tok-ss">:table1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/insert-values</span> <span class="tok-p">{</span><span class="tok-ss">:f1</span> <span class="tok-mi">1</span> <span class="tok-ss">:f2</span> <span class="tok-mi">2</span> <span class="tok-ss">:f3</span> <span class="tok-mi">3</span><span class="tok-p">})</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/insert-values</span> <span class="tok-p">{</span><span class="tok-ss">:f1</span> <span class="tok-mi">4</span> <span class="tok-ss">:f2</span> <span class="tok-mi">5</span> <span class="tok-ss">:f3</span> <span class="tok-mi">6</span><span class="tok-p">})</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sqlvec</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; [&quot;insert into t1 (f1, f2, f3) values (?, ?, ?), (?, ?, ?)&quot; 1 2 3 4 5 6]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_update_statement"><a class="link" href="#_the_update_statement">The UPDATE statement</a></h3>
<div class="paragraph">
<p>The UPDATE statement is used to modify one or several pre-existing records in
a database table.</p>
</div>
<div class="listingblock">
<div class="title">Example of update statement without condition.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/update</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/set</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;foo&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;update t1 set name = ?&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of update statement without condition using a map</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/update</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/set</span> <span class="tok-p">{</span><span class="tok-ss">:name</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-ss">:bar</span> <span class="tok-s">&quot;baz&quot;</span><span class="tok-p">})</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;update t1 set name = ?, bar = ?&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of update statement with one condition.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/update</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/set</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;foo&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-p">[</span><span class="tok-s">&quot;id = ?&quot;</span> <span class="tok-mi">1</span><span class="tok-p">])</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;update t1 set name = ? where (id = ?)&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of update statement using subquery.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/update</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/set</span> <span class="tok-ss">:f1</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:f2</span><span class="tok-p">)</span>
                     <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:t2</span><span class="tok-p">)</span>
                     <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-p">[</span><span class="tok-s">&quot;id = ?&quot;</span> <span class="tok-mi">2</span><span class="tok-p">])))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span> <span class="tok-p">{</span><span class="tok-ss">:dialect</span> <span class="tok-ss">:pgsql</span><span class="tok-p">}))</span>
<span class="tok-c1">;; =&gt; &quot;update t1 set f1 = (select f2 from t2 where (id = ?))&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of multiple assignation un update statement using subquery.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/update</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/set</span> <span class="tok-p">(</span><span class="tok-nf">dsl/row</span> <span class="tok-p">(</span><span class="tok-nf">dsl/field</span> <span class="tok-ss">:f1</span><span class="tok-p">)</span>
                      <span class="tok-p">(</span><span class="tok-nf">dsl/field</span> <span class="tok-ss">:f2</span><span class="tok-p">))</span>
             <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:f3</span> <span class="tok-ss">:f4</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:t2</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-p">[</span><span class="tok-s">&quot;id = ?&quot;</span> <span class="tok-mi">2</span><span class="tok-p">])))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span> <span class="tok-p">{</span><span class="tok-ss">:dialect</span> <span class="tok-ss">:pgsql</span><span class="tok-p">}))</span>
<span class="tok-c1">;; =&gt; &quot;update t1 set (f1, f2) = (select f3, f4 from t2 where (id = ?))&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of returning clause used in UPDATE statement.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/update</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/set</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;foo&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/returning</span> <span class="tok-ss">:id</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span> <span class="tok-p">{</span><span class="tok-ss">:dialect</span> <span class="tok-ss">:pgsql</span><span class="tok-p">}))</span>
<span class="tok-c1">;; =&gt; &quot;update t1 set name = ? returning id&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example using function as value.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/update</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/set</span> <span class="tok-ss">:name</span> <span class="tok-p">(</span><span class="tok-nf">dsl/f</span> <span class="tok-p">[</span><span class="tok-s">&quot;concat(name, ?)&quot;</span> <span class="tok-s">&quot;-foo&quot;</span><span class="tok-p">]))</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/set</span> <span class="tok-ss">:name_length</span> <span class="tok-p">(</span><span class="tok-nf">dsl/f</span> <span class="tok-s">&quot;length(name)&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/returning</span> <span class="tok-ss">:id</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span> <span class="tok-p">{</span><span class="tok-ss">:dialect</span> <span class="tok-ss">:pgsql</span><span class="tok-p">}))</span>
<span class="tok-c1">;; =&gt; &quot;update t1 set name = ? returning id&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_delete_statement"><a class="link" href="#_the_delete_statement">The DELETE statement</a></h3>
<div class="listingblock">
<div class="title">Simple example of delete statement with one condition</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/delete</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-s">&quot;id = 1&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;delete from t1 where (id = 1)&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_ddl_statements"><a class="link" href="#_the_ddl_statements">The DDL statements</a></h3>
<div class="sect3">
<h4 id="_the_truncate_statement"><a class="link" href="#_the_truncate_statement">The TRUNCATE statement</a></h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/truncate</span> <span class="tok-ss">:table1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;truncate table table1&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_create_table_statement"><a class="link" href="#_the_create_table_statement">The CREATE TABLE statement</a></h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/create-table</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/add-column</span> <span class="tok-ss">:title</span> <span class="tok-p">{</span><span class="tok-ss">:type</span> <span class="tok-ss">:pg/varchar</span> <span class="tok-ss">:length</span> <span class="tok-mi">100</span> <span class="tok-ss">:null</span> <span class="tok-nv">false</span><span class="tok-p">})</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;create table t1 (title varchar(100) not null)&quot;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
at this moment, the add-column function doest not permit the way to setup
default value for a field in table creation statement.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_drop_table_statement"><a class="link" href="#_the_drop_table_statement">The DROP TABLE statement</a></h4>
<div class="listingblock">
<div class="title">Drop table example</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/drop-table</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;drop table t1&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_alter_table_statement"><a class="link" href="#_the_alter_table_statement">The ALTER TABLE statement</a></h4>
<div class="paragraph">
<p>Alter statements are used mainly to add, modify or delete columns from table.</p>
</div>
<div class="listingblock">
<div class="title">Add new column</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/alter-table</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/add-column</span> <span class="tok-ss">:title</span> <span class="tok-p">{</span><span class="tok-ss">:type</span> <span class="tok-ss">:pg/varchar</span> <span class="tok-ss">:length</span> <span class="tok-mi">2</span> <span class="tok-ss">:null</span> <span class="tok-nv">false</span><span class="tok-p">})</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;alter table t1 add title varchar(2) not null&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Change type of column</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/alter-table</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/alter-column</span> <span class="tok-ss">:title</span> <span class="tok-p">{</span><span class="tok-ss">:type</span> <span class="tok-ss">:pg/varchar</span> <span class="tok-ss">:length</span> <span class="tok-mi">100</span> <span class="tok-ss">:null</span> <span class="tok-nv">false</span><span class="tok-p">})</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;alter table t1 alter title varchar(100) not null&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Drop column</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/alter-table</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/drop-column</span> <span class="tok-ss">:title</span> <span class="tok-ss">:cascade</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;alter table t1 drop title cascade&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-index"><a class="link" href="#create-index">The CREATE INDEX statement</a></h4>
<div class="listingblock">
<div class="title">Create simple on field</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/create-index</span> <span class="tok-s">&quot;test&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/on</span> <span class="tok-ss">:t1</span> <span class="tok-ss">:title</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;create index \&quot;test\&quot; on t1(title)&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Create index on field expression</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/create-index</span> <span class="tok-s">&quot;test&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/on</span> <span class="tok-ss">:t1</span> <span class="tok-p">(</span><span class="tok-nf">dsl/field</span> <span class="tok-s">&quot;lower(title)&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;create index \&quot;test\&quot; on t1(lower(title))&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="drop-index"><a class="link" href="#drop-index">The DROP INDEX statement</a></h4>
<div class="listingblock">
<div class="title">Drop index</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/drop-index</span> <span class="tok-s">&quot;test&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;drop index \&quot;test\&quot;&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_create_sequence_statement"><a class="link" href="#_the_create_sequence_statement">The CREATE SEQUENCE statement</a></h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/create-sequence</span> <span class="tok-s">&quot;testseq&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;create sequence \&quot;testseq\&quot;&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_alter_sequence_statement"><a class="link" href="#_the_alter_sequence_statement">The ALTER SEQUENCE statement</a></h4>
<div class="listingblock">
<div class="title">Restart sequence</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/alter-sequence</span> <span class="tok-s">&quot;testseq&quot;</span> <span class="tok-nv">true</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;alter sequence \&quot;testseq\&quot; restart&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Restart sequence with concrete number</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/alter-sequence</span> <span class="tok-s">&quot;testseq&quot;</span> <span class="tok-mi">19</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;alter sequence \&quot;testseq\&quot; restart with 19&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_drop_sequence_statement"><a class="link" href="#_the_drop_sequence_statement">The DROP SEQUENCE statement</a></h4>
<div class="listingblock">
<div class="title">Drop sequence</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/drop-sequence</span> <span class="tok-s">&quot;testseq&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;drop sequence \&quot;testseq\&quot;&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Drop sequence if exists</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/drop-sequence</span> <span class="tok-s">&quot;testseq&quot;</span> <span class="tok-nv">true</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;drop sequence if exists \&quot;testseq\&quot;&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_table_expressions"><a class="link" href="#_table_expressions">Table Expressions</a></h3>
<div class="sect3">
<h4 id="_the_values_table_constructor"><a class="link" href="#_the_values_table_constructor">The VALUES() table constructor</a></h4>
<div class="paragraph">
<p>Some databases allow expressing in-memory temporary tables using a <code>values()</code> syntax.</p>
</div>
<div class="listingblock">
<div class="title">Select from <code>values()</code> example</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:f1</span> <span class="tok-ss">:f2</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/values</span> <span class="tok-p">(</span><span class="tok-nf">dsl/row</span> <span class="tok-mi">1</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
                              <span class="tok-p">(</span><span class="tok-nf">dsl/row</span> <span class="tok-mi">3</span> <span class="tok-mi">4</span><span class="tok-p">))</span>
                  <span class="tok-p">(</span><span class="tok-nf">dsl/as-table</span> <span class="tok-s">&quot;t1&quot;</span> <span class="tok-s">&quot;f1&quot;</span> <span class="tok-s">&quot;f2&quot;</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span> <span class="tok-p">{</span><span class="tok-ss">:type</span> <span class="tok-ss">:inlined</span><span class="tok-p">}))</span>
<span class="tok-c1">;; =&gt; &quot;select f1, f2 from (values(1, 2), (3, 4)) as \&quot;t1\&quot; (\&quot;f1\&quot;, \&quot;f2\&quot;)&quot;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<code>suricatta.dsl/row</code> is defined as a macro and only accepts literals.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_nested_selects"><a class="link" href="#_nested_selects">Nested SELECTs</a></h4>
<div class="listingblock">
<div class="title">Using nested select in where clause</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-p">(</span><span class="tok-nb">list </span><span class="tok-s">&quot;book.age = ({0})&quot;</span> <span class="tok-p">(</span><span class="tok-nf">dsl/select-one</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>

<span class="tok-c1">;; =&gt; &quot;select * from book where (book.age = (select 1 as \&quot;one\&quot;))&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Using nested select in from clause</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:f1</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:t1</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nf">dsl/as-table</span> <span class="tok-s">&quot;tt1&quot;</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select \&quot;tt1\&quot;.\&quot;f1\&quot; from (select f1 from t1) as \&quot;tt1\&quot;(\&quot;f1\&quot;)&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Using nested select in select fields clauses</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-ss">:fullname</span>, <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">dsl/select</span> <span class="tok-p">(</span><span class="tok-nf">dsl/field</span> <span class="tok-s">&quot;count(*)&quot;</span><span class="tok-p">))</span>
                               <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:book</span><span class="tok-p">)</span>
                               <span class="tok-p">(</span><span class="tok-nf">dsl/where</span> <span class="tok-s">&quot;book.authorid = author.id&quot;</span><span class="tok-p">)</span>
                               <span class="tok-p">(</span><span class="tok-nf">dsl/as-field</span> <span class="tok-s">&quot;books&quot;</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nf">dsl/from</span> <span class="tok-ss">:author</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">fmt/sql</span><span class="tok-p">))</span>
<span class="tok-c1">;; =&gt; &quot;select fullname, (select count(*) from book where (book.authorid = author.id)) &quot;books&quot; from author&quot;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_faq"><a class="link" href="#_faq">FAQ</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_why_i_should_use_suricatta_instead_of_clojure_jdbc_or_java_jdbc"><a class="link" href="#_why_i_should_use_suricatta_instead_of_clojure_jdbc_or_java_jdbc">Why I should use suricatta instead of clojure.jdbc or java.jdbc?</a></h3>
<div class="paragraph">
<p>Unlike any jdbc library, <em>suricatta</em> works at a slightly higher level. It hides a
lot of idiosyncrasies of jdbc under a much <strong>simpler, cleaner and less error prone
api</strong>, with better resource management.</p>
</div>
</div>
<div class="sect2">
<h3 id="_where_is_the_async_support"><a class="link" href="#_where_is_the_async_support">Where is the async support?</a></h3>
<div class="paragraph">
<p>In previous version <em>suricatta</em> it had come with asynchronous support using
core.async channels as response but since the version 0.4.0 it is removed because
core.async is not a proper abstraction for represent a promise.</p>
</div>
<div class="paragraph">
<p>In the jvm world, the proper promise abstraction is introduced in JDK8 so using
that abstraction will force people use JDK8, something that I don&#8217;t want to do at
this moment.</p>
</div>
<div class="paragraph">
<p>The great news is that async support is stil very easy implement, so you can do
it in your own code base defining two additional functions. Here a code snippet
for it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">suricatta.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">sc</span><span class="tok-p">]</span>
         <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cats.monad.exception</span> <span class="tok-ss">:as</span> <span class="tok-nv">exc</span><span class="tok-p">]</span>
         <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">promissum.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">p</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">execute</span>
  <span class="tok-s">&quot;Execute a query asynchronously returning a CompletableFuture.&quot;</span>
  <span class="tok-p">([</span><span class="tok-nv">ctx</span> <span class="tok-nv">q</span><span class="tok-p">]</span>
   <span class="tok-p">(</span><span class="tok-nf">execute</span> <span class="tok-nv">ctx</span> <span class="tok-nv">q</span> <span class="tok-p">{}))</span>
  <span class="tok-p">([</span><span class="tok-nv">ctx</span> <span class="tok-nv">q</span> <span class="tok-nv">opts</span><span class="tok-p">]</span>
   <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">act</span> <span class="tok-p">(</span><span class="tok-nf">.-act</span> <span class="tok-nv">ctx</span><span class="tok-p">)</span>
         <span class="tok-nv">fun</span> <span class="tok-o">#</span><span class="tok-p">(</span><span class="tok-nf">%</span> <span class="tok-p">(</span><span class="tok-nf">exc/try-on</span> <span class="tok-p">(</span><span class="tok-nf">sc/execute</span> <span class="tok-nv">ctx</span> <span class="tok-nv">q</span><span class="tok-p">)))]</span>
     <span class="tok-p">(</span><span class="tok-nf">p/promise</span>
      <span class="tok-p">(</span><span class="tok-k">fn </span><span class="tok-p">[</span><span class="tok-nv">deliver</span><span class="tok-p">]</span>
        <span class="tok-p">(</span><span class="tok-nb">send-off </span><span class="tok-nv">act</span> <span class="tok-p">(</span><span class="tok-k">fn </span><span class="tok-p">[</span><span class="tok-nv">_</span><span class="tok-p">]</span> <span class="tok-p">(</span><span class="tok-nf">fun</span> <span class="tok-nv">deliver</span><span class="tok-p">))))))))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">fetch</span>
  <span class="tok-s">&quot;Execute a query asynchronously returning a CompletableFuture.&quot;</span>
  <span class="tok-p">([</span><span class="tok-nv">ctx</span> <span class="tok-nv">q</span><span class="tok-p">]</span>
   <span class="tok-p">(</span><span class="tok-nf">fetch</span> <span class="tok-nv">ctx</span> <span class="tok-nv">q</span> <span class="tok-p">{}))</span>
  <span class="tok-p">([</span><span class="tok-nv">ctx</span> <span class="tok-nv">q</span> <span class="tok-nv">opts</span><span class="tok-p">]</span>
   <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">act</span> <span class="tok-p">(</span><span class="tok-nf">.-act</span> <span class="tok-nv">ctx</span><span class="tok-p">)</span>
         <span class="tok-nv">fun</span> <span class="tok-o">#</span><span class="tok-p">(</span><span class="tok-nf">%</span> <span class="tok-p">(</span><span class="tok-nf">exc/try-on</span> <span class="tok-p">(</span><span class="tok-nf">sc/fetch</span> <span class="tok-nv">ctx</span> <span class="tok-nv">q</span> <span class="tok-nv">opts</span><span class="tok-p">)))]</span>
     <span class="tok-p">(</span><span class="tok-nf">p/promise</span>
      <span class="tok-p">(</span><span class="tok-k">fn </span><span class="tok-p">[</span><span class="tok-nv">deliver</span><span class="tok-p">]</span>
        <span class="tok-p">(</span><span class="tok-nb">send-off </span><span class="tok-nv">act</span> <span class="tok-p">(</span><span class="tok-k">fn </span><span class="tok-p">[</span><span class="tok-nv">_</span><span class="tok-p">]</span> <span class="tok-p">(</span><span class="tok-nf">fun</span> <span class="tok-nv">deliver</span><span class="tok-p">))))))))</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_why_another_dsl_is_it_just_yet_another_dsl"><a class="link" href="#_why_another_dsl_is_it_just_yet_another_dsl">Why another dsl? Is it just yet another dsl?</a></h3>
<div class="paragraph">
<p>First <em>suricatta</em> is not a dsl library, it&#8217;s a sql toolkit, and one part of the
toolkit is a dsl.</p>
</div>
<div class="paragraph">
<p>Secondly, <em>suricatta</em>'s dsl&#8217;s don&#8217;t intends to be a sql abstraction. The real
purpose of <em>suricatta</em>'s dsl is make SQL composable while still allowing use all or
almost all vendor specific sql constructions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_are_some_suricatta_use_cases"><a class="link" href="#_what_are_some_suricatta_use_cases">What are some suricatta use cases?</a></h3>
<div class="paragraph">
<p>The <em>suricatta</em> library is very flexible and it can be used in very different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can build queries with <em>suricatta</em> and execute them with <em>clojure.jdbc</em>.</p>
</li>
<li>
<p>You can use <em>suricatta</em> for executing queries with string-based sql.</p>
</li>
<li>
<p>You can combine the <em>suricatta</em> library with <em>clojure.jdbc</em>.</p>
</li>
<li>
<p>And obviously, you can forget jdbc and use <em>suricatta</em> for both purposes, building
and/or executing queries.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_is_it_a_korma_clone"><a class="link" href="#_is_it_a_korma_clone">Is it a korma-clone?</a></h3>
<div class="paragraph">
<p>Nope, it&#8217;s not korma clone, because it works very different, and it has a different
philosophy.</p>
</div>
<div class="paragraph">
<p><em>suricatta</em> has cleaner differentiation between dsl and query execution/fetching.
It doesn&#8217;t intend to be a replacement of Korma, it intends be a replacement to raw
jdbc access to the database.</p>
</div>
</div>
<div class="sect2">
<h3 id="_is_a_jooq_comercial_license_requried"><a class="link" href="#_is_a_jooq_comercial_license_requried">Is a JOOQ comercial license requried?</a></h3>
<div class="paragraph">
<p>Not, <em>suricatta</em> works and is tested with the opensource (Apache 2.0 licensed)
version of JOOQ.</p>
</div>
<div class="paragraph">
<p>I have plans to make <em>suricatta</em> work with enterprise version of JOOQ for users
that want to use "enterprise" databases in the future. In any case, that will not
affect the open source version.</p>
</div>
</div>
<div class="sect2">
<h3 id="_can_i_store_safely_queries_builded_by_dsl_in_a_var_they_are_immutable"><a class="link" href="#_can_i_store_safely_queries_builded_by_dsl_in_a_var_they_are_immutable">Can I store safely queries builded by DSL in a var, they are immutable?</a></h3>
<div class="paragraph">
<p>Yes. Unlike JOOQ DSL interface which has a mutable api, <em>suricatta</em> exposes an
immutable api for building queries.</p>
</div>
<div class="paragraph">
<p>Queries built with <em>suricatta</em> can be safely shared through different threads.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_developers_guide"><a class="link" href="#_developers_guide">Developers Guide</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_philosophy"><a class="link" href="#_philosophy">Philosophy</a></h3>
<div class="paragraph">
<p>The five most important rules are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Beautiful is better than ugly.</p>
</li>
<li>
<p>Explicit is better than implicit.</p>
</li>
<li>
<p>Simple is better than complex.</p>
</li>
<li>
<p>Complex is better than complicated.</p>
</li>
<li>
<p>Readability counts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All contributions to <em>suricatta</em> should keep these important rules in mind.</p>
</div>
</div>
<div class="sect2">
<h3 id="_contributing"><a class="link" href="#_contributing">Contributing</a></h3>
<div class="paragraph">
<p>Unlike Clojure and other Clojure contributed libraries <em>suricatta</em> does not have many
restrictions for contributions. Just open an issue or pull request.</p>
</div>
</div>
<div class="sect2">
<h3 id="_source_code"><a class="link" href="#_source_code">Source Code</a></h3>
<div class="paragraph">
<p><em>suricatta</em> is open source and can be found on
<a href="https://github.com/funcool/suricatta">github</a>.</p>
</div>
<div class="paragraph">
<p>You can clone the public repository with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">git clone https://github.com/funcool/suricatta</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_tests"><a class="link" href="#_run_tests">Run tests</a></h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">lein test</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_license"><a class="link" href="#_license">License</a></h3>
<div class="paragraph">
<p><em>suricatta</em> is licensed under BSD (2-Clause) license:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Copyright (c) 2014-2015 Andrey Antukh &lt;niwi@niwi.nz&gt;

All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

* Redistributions of source code must retain the above copyright notice, this
  list of conditions and the following disclaimer.

* Redistributions in binary form must reproduce the above copyright notice,
  this list of conditions and the following disclaimer in the documentation
  and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-12-25 12:38:35 CET
</div>
</div>
</body>
</html>